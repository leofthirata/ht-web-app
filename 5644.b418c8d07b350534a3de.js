(self.webpackChunkht_web_app=self.webpackChunkht_web_app||[]).push([[5644],{5644:(e,t,i)=>{"use strict";i.r(t),i.d(t,{TestingPageModule:()=>v});var n=i(8583),s=i(665),o=i(3083),r=i(2316),c=i(4762),d=i(5681);class h{constructor(){this.RSA_KEY_SIZE=1024,this.m_rsa=(0,d.Qs)(this.RSA_KEY_SIZE),this.m_pubKey=(0,d.$3)(this.m_rsa),this.m_privKey=(0,d.xp)(this.m_rsa),(0,d.qC)(this.m_pubKey),(0,d.jO)(this.m_privKey)}getPubKey(){return this.m_pubKey}getPrivKey(){return this.m_privKey}}var l=(()=>(function(e){e[e.GET_KEY=0]="GET_KEY",e[e.SET_SECRET=1]="SET_SECRET",e[e.SET_TICKET=2]="SET_TICKET",e[e.SEND_CMD=3]="SEND_CMD"}(l||(l={})),l))();class u{constructor(e){this.RSA_BLOCK_SIZE_HEX=117,this.RSA_BLOCK_SIZE_B64=256,this.m_state=e}open(e,t){return this.m_uri=e,this.m_privKey=t,new Promise(t=>{this.m_ws=new WebSocket(e),this.m_ws.onopen=e=>{console.log("open:\n"),console.log(e),t(!0)},this.m_ws.onerror=e=>{console.log("error:\n"),console.log(e),t(!1)}})}send(e,t){return t&&(this.m_devicePublicKey=t),new Promise(t=>{switch(console.log(this.m_state),this.m_state){case l.GET_KEY:this.m_ws.send(JSON.stringify(e)),this.m_state=l.SEND_CMD;break;case l.SEND_CMD:this.m_ws.send(this._encryptWebsocketJSON(JSON.stringify(e)))}t(!0)})}receive(){return new Promise(e=>{this.m_ws.binaryType="arraybuffer",this.m_ws.onmessage=t=>{const i=this.decryptWebsocketJSON(new Uint8Array(t.data));e(i)}})}_encryptWebsocketJSON(e){const t=Math.ceil(e.length/117),i=new Uint8Array(128*t);for(let n=0;n<t;n++){const t=Math.min(117*(n+1),e.length),s=e.substring(117*n,t),o=(0,d.Vw)(s,this.m_devicePublicKey),r=this.stringToBytes(o);i.set(r,128*n)}return i}decryptWebsocketJSON(e){const t=Math.ceil(e.length/128);let i="";for(let n=0;n<t;n++){const t=e.slice(128*n,128*(n+1)),s=this.bytesToString(t);i+=(0,d.Iw)(s,this.m_privKey)}return i}stringToBytes(e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}bytesToString(e){const t=[];for(const i of e)t.push(String.fromCharCode(i));return t.join("")}buf2hex(e){return[...new Uint8Array(e)].map(e=>e.toString(16).padStart(2,"0")).join("")}}var a=i(4218),m=i(6909);const y="http://stage.padotec.com.br:8011/devices-service/v1";var _=i(639);const p=function(){return["/testing"]},g=[{path:"",component:(()=>{class e{constructor(e){this.router=e,this.m_state=l.GET_KEY,this.gotKey=!1,this.secretSet=!1,this.ticketSet=!1,this.deviceRegistered=!1,e.getCurrentNavigation().extras.state&&(this.m_ip=this.router.getCurrentNavigation().extras.state,console.log(this.m_ip))}ngOnInit(){this.m_auth=new h}getKey(){return(0,c.mG)(this,void 0,void 0,function*(){this.gotKey=!0;let e={key:m.pki.publicKeyToPem(this.m_auth.getPubKey())};const t=new u(this.m_state),i=(yield t.open(`ws://${this.m_ip}/get_key`,this.m_auth.getPrivKey()),yield t.send(e),yield t.receive());console.log(i),this.m_devicePublicKey=(0,d.aQ)(JSON.parse(i).key),(0,d.qC)(this.m_devicePublicKey),this.m_state=l.SEND_CMD,this.gotKey=!0})}setSecret(){return(0,c.mG)(this,void 0,void 0,function*(){this.m_secret=(0,a.fv)(window.crypto.getRandomValues(new Uint8Array(16)));let e={secret:this.m_secret,key:m.pki.publicKeyToPem(this.m_auth.getPubKey())};const t=new u(this.m_state),i=(yield t.open(`ws://${this.m_ip}/set_secret`,this.m_auth.getPrivKey()),yield t.send(e,this.m_devicePublicKey),yield t.receive());if("fail"==JSON.parse(i).mg)throw"SECRET_FAIL";this.secretSet=!0})}registerDevice(){return(0,c.mG)(this,void 0,void 0,function*(){const e=yield function(e){return(0,c.mG)(this,void 0,void 0,function*(){let e=yield fetch("https://stage.padotec.com.br/auth/realms/hausenn/protocol/openid-connect/token",{method:"post",body:"client_id=hausenn-client-app&grant_type=refresh_token&refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIwZDU4YmIzYy1hNzZjLTQwYzEtYjA4ZS01MjJkOGQwMmE1ZjUifQ.eyJqdGkiOiJiZmI4ZTA1MC0zMGE0LTQyMmItOTc5Ni0xMzEzMzQ3YjRjMTUiLCJleHAiOjAsIm5iZiI6MCwiaWF0IjoxNjI1NzQ4MDkwLCJpc3MiOiJodHRwczovL3N0YWdlLnBhZG90ZWMuY29tLmJyL2F1dGgvcmVhbG1zL2hhdXNlbm4iLCJhdWQiOiJodHRwczovL3N0YWdlLnBhZG90ZWMuY29tLmJyL2F1dGgvcmVhbG1zL2hhdXNlbm4iLCJzdWIiOiJkZTFjMmIyMy1hNGM0LTRiYzQtYjQ2Ni0zNTM4OTVmNTgxOTAiLCJ0eXAiOiJPZmZsaW5lIiwiYXpwIjoiaGF1c2Vubi1jbGllbnQtYXBwIiwiYXV0aF90aW1lIjowLCJzZXNzaW9uX3N0YXRlIjoiMTM5MzAyZjgtZDBhZC00ZjFjLWJlOWQtOTRlYjdkMGNhNTJmIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6Im9wZW5pZCBvZmZsaW5lX2FjY2VzcyBlbWFpbCBwcm9maWxlIn0.TqvywFzLXqEYZHCi1w4EAwFNQPfGPyfA14IJ5Bu_bac",headers:{"Content-Type":"application/x-www-form-urlencoded"}});return(yield e.json()).access_token})}(),t=(yield function(e){return(0,c.mG)(this,void 0,void 0,function*(){let t=yield fetch(`${y}/sync`,{method:"get",headers:{Authorization:`Bearer ${e}`}});const i=yield t.json();return{uuid:i.user_profile[0].uuid,ticket:i.user_profile[0].ticket}})}(e),yield function(e,t,i){return(0,c.mG)(this,void 0,void 0,function*(){let t=yield fetch(`${y}/places`,{method:"post",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({address:"Address1",name:"Local1"})});return(yield t.json()).idPlace})}(e)),i=yield function(e,t,i){return(0,c.mG)(this,void 0,void 0,function*(){let i=yield fetch(`${y}/environments`,{method:"post",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({id_place:t,name_env:"Environment1"})});return(yield i.json()).id_env})}(e,t),n=yield function(e,t,i,n,s,o,r,d,h,l){return(0,c.mG)(this,void 0,void 0,function*(){let n=yield fetch(`${y}/devices`,{method:"post",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({ble_key:"02E596CDAB2D81320A94BFD6D52BAFAE",ble_mac:"321321",channel:3,id_env:i,ip:s,latitude:"null",longitude:"null",mac:"123123",public_key:l,name_device:"Device1",secret:e,ssid:"PADOTEC",type:"one"})});const o=yield n.json();return console.log(o),{ticket:o.device_ticket,uuid:o.idDevice}})}(this.m_secret,e,i,0,this.m_ip,0,0,0,0,m.pki.publicKeyToPem(this.m_devicePublicKey));console.log(n),this.deviceRegistered=!0})}setTicket(){return(0,c.mG)(this,void 0,void 0,function*(){let e={ticket:this.m_deviceTicket,uuid:this.m_deviceUuid,key:m.pki.publicKeyToPem(this.m_auth.getPubKey())};const t=new u(this.m_state),i=(yield t.open(`ws://${this.m_ip}/set_ticket`,this.m_auth.getPrivKey()),yield t.send(e,this.m_devicePublicKey),yield t.receive());if("fail"==JSON.parse(i).mg)throw"TICKET_FAIL";this.ticketSet=!0})}}return e.\u0275fac=function(t){return new(t||e)(_.Y36(r.F0))},e.\u0275cmp=_.Xpm({type:e,selectors:[["app-testing"]],decls:16,vars:12,consts:[[1,"auth-form"],["align-self-center",""],["expand","block","color","primary",3,"routerLink","disabled","click"]],template:function(e,t){1&e&&(_.TgZ(0,"ion-header"),_.TgZ(1,"ion-toolbar"),_.TgZ(2,"ion-title"),_._uU(3,"Authentication"),_.qZA(),_.qZA(),_.qZA(),_.TgZ(4,"ion-content",0),_.TgZ(5,"ion-grid"),_.TgZ(6,"ion-row"),_.TgZ(7,"ion-col",1),_.TgZ(8,"ion-button",2),_.NdJ("click",function(){return t.getKey()}),_._uU(9,"GET_KEY"),_.qZA(),_.TgZ(10,"ion-button",2),_.NdJ("click",function(){return t.setSecret()}),_._uU(11,"SET_SECRET"),_.qZA(),_.TgZ(12,"ion-button",2),_.NdJ("click",function(){return t.registerDevice()}),_._uU(13,"REGISTER_DEVICE"),_.qZA(),_.TgZ(14,"ion-button",2),_.NdJ("click",function(){return t.setTicket()}),_._uU(15,"SET_TICKET"),_.qZA(),_.qZA(),_.qZA(),_.qZA(),_.qZA()),2&e&&(_.xp6(8),_.Q6J("routerLink",_.DdM(8,p))("disabled",t.gotKey),_.xp6(2),_.Q6J("routerLink",_.DdM(9,p))("disabled",t.secretSet),_.xp6(2),_.Q6J("routerLink",_.DdM(10,p))("disabled",t.deviceRegistered),_.xp6(2),_.Q6J("routerLink",_.DdM(11,p))("disabled",t.ticketSet))},directives:[o.Gu,o.sr,o.wd,o.W2,o.jY,o.Nd,o.wI,o.YG,o.YI,r.rH],styles:[""]}),e})()}];let b=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=_.oAB({type:e}),e.\u0275inj=_.cJS({imports:[[r.Bz.forChild(g)],r.Bz]}),e})(),v=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=_.oAB({type:e}),e.\u0275inj=_.cJS({imports:[[n.ez,s.u5,o.Pc,b]]}),e})()}}]);